# API Gateway HTTP API v2 Configuration for SafeSim
# This uses API Gateway HTTP API v2 which supports WebSockets for Streamlit

AWSTemplateFormatVersion: '2010-09-09'
Description: 'API Gateway HTTP API v2 for SafeSim Streamlit Application'

Parameters:
  StreamlitBackendUrl:
    Type: String
    Description: 'URL of the Streamlit backend (EC2, ECS, or App Runner)'
    Default: 'http://your-streamlit-backend:8501'
  
  DomainName:
    Type: String
    Description: 'Custom domain name (optional)'
    Default: ''

Resources:
  # HTTP API Gateway (v2) - Supports WebSockets
  SafeSimHttpApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: safesim-api
      ProtocolType: HTTP
      CorsConfiguration:
        AllowOrigins:
          - '*'
        AllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        AllowHeaders:
          - '*'
        MaxAge: 300
      Tags:
        - Key: Project
          Value: SafeSim

  # Integration with Streamlit backend
  StreamlitIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref SafeSimHttpApi
      IntegrationType: HTTP_PROXY
      IntegrationUri: !Ref StreamlitBackendUrl
      IntegrationMethod: ANY
      PayloadFormatVersion: '1.0'
      ConnectionType: INTERNET
      TimeoutInMillis: 30000

  # Default route - proxy all requests to Streamlit
  DefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref SafeSimHttpApi
      RouteKey: '$default'
      Target: !Sub 'integrations/${StreamlitIntegration}'

  # Health check route
  HealthRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref SafeSimHttpApi
      RouteKey: 'GET /_stcore/health'
      Target: !Sub 'integrations/${StreamlitIntegration}'

  # Stage
  ApiStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref SafeSimHttpApi
      StageName: prod
      AutoDeploy: true
      DefaultRouteSettings:
        ThrottlingBurstLimit: 5000
        ThrottlingRateLimit: 2000
        DetailedMetricsEnabled: true

  # Custom Domain (optional)
  ApiDomainName:
    Type: AWS::ApiGatewayV2::DomainName
    Condition: HasCustomDomain
    Properties:
      DomainName: !Ref DomainName
      DomainNameConfigurations:
        - CertificateArn: !Ref SSLCertificateArn
          EndpointType: REGIONAL

  ApiDomainMapping:
    Type: AWS::ApiGatewayV2::ApiMapping
    Condition: HasCustomDomain
    Properties:
      ApiId: !Ref SafeSimHttpApi
      DomainName: !Ref ApiDomainName
      Stage: !Ref ApiStage

Conditions:
  HasCustomDomain: !Not [!Equals [!Ref DomainName, '']]

Outputs:
  ApiEndpoint:
    Description: 'API Gateway HTTP API endpoint URL'
    Value: !Sub 'https://${SafeSimHttpApi}.execute-api.${AWS::Region}.amazonaws.com/prod'
  
  ApiId:
    Description: 'API Gateway HTTP API ID'
    Value: !Ref SafeSimHttpApi

